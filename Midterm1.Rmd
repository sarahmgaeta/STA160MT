---
title: "STA 160 Midterm1"
author: "Eric Gao"
date: "4/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, message = FALSE, warning=FALSE}
setwd("~/STA160")
library(tidyverse)
library(readxl)
library(corrplot)
library(ggmap)
```

```{r}
airbnb =  read_csv("Airbnb_NYC_2019.csv", col_types = cols(last_review = col_date(format = "%Y-%m-%d")))
```

# What causes prices to be higher and can we make a model to predict the price?
# Do the number of reviews differ per borough?
# Does price vary with neighborhood?
# cluster neighborhood


First, let's clean the data

```{r}
airbnb = airbnb %>% na.omit()
#next remove all 0's from price
price_0 = which(airbnb$price >0, )
airbnb = airbnb[price_0, ]
#use minimum nights <= 20
```



First, we will plot the correlograms between the columns of numerical type

```{r}
updated_airbnb = airbnb %>% keep(is.numeric)
updated = updated_airbnb[,-c(1,2,3,4)] %>% na.omit()
#pairs(updated)
```

Next, we will plot the respective correlation matrix between the numerical variables:

```{r}
corrplot(cor(updated), method = "number")
```

```{r}
summary(updated)
```

We will get rid of zero price, because a price of 0 is senseless:

```{r}
price_over0 = which(airbnb$price > 0)
airbnb = airbnb[price_over0, ]
```

Then, get the count of each borough:

```{r}
ggplot(airbnb, aes(x=neighbourhood_group, fill = as.factor(neighbourhood_group))) + geom_bar()
```

Look at the mean price for each borough:


First, we want to see if prices are greater for certain neighborhood groups:
#cheaper airbnbs

```{r}
ggplot(airbnb[which(airbnb$price <= 175), ], aes(x= neighbourhood_group , y= price)) + geom_boxplot()
```
average listenings in Manhattan more expensive ish than average of other groups.


#more expensive:
```{r}
ggplot(airbnb[which(airbnb$price > 1000), ], aes(x= neighbourhood_group , y= price)) + geom_boxplot()
```

more variability around the more expensive groups in Broklyn and Queens

# what kind of airbnb has prices over 1000?-could be interesting(what is similar-could be specific people)
```{r}
price_500 = which(airbnb$price >= 500)
airbnb_over_500 = airbnb[price_500, ]
ggplot(airbnb_over_500, aes(neighbourhood_group, fill = neighbourhood_group)) + geom_bar()
```



```{r}
manhattan_1000 = which(airbnb_over_1000$neighbourhood_group == "Manhattan")
airbnb_man_1000 = airbnb_over_1000[manhattan_1000, ]
ggplot(airbnb_man_1000, aes(price, fill = room_type)) + geom_histogram()
```

From the plot above, we can see that for prices over $1000, we see that across all the prices, the ones that cost the most are entire homes/apts.

Let's find out which borough has more of which room type for the more expensive prices(over 1000).

```{r}
expensive_air = airbnb_over_1000 %>% group_by(neighbourhood_group) %>% count(room_type)
ggplot(data = expensive_air, aes(x=room_type, y=n, fill = as.factor(neighbourhood_group))) + geom_bar(stat = "identity", position =position_dodge())
```

This pattern of more expensive apartments(1000+) being entire homes holds true.

Let's take a look at 




We will remove the name and host_name columns since they are represented by id and host_id:

```{r}
new_air = airbnb[, -c(2, 4)]
```   








```{r, warning = F, message=FALSE}
library(tigris)
library(dplyr)
library(leaflet)
library(sp)
library(ggmap)
library(maptools)
library(broom)
library(httr)
library(rgdal)
library(sf)
library(here)
```


```{r}
ny = ggplot(data = airbnb, aes(longitude, latitude, color = as.factor(neighbourhood_group))) + coord_quickmap() + geom_point() + annotate("text", x= -74, y = 40.75 , label = "MSG") 
ny
msg = c(-40.75, -73.9934)
```


```{r}
# ggplot() + 
#   geom_polygon(data = worldmap, 
#                aes(x = long, y = lat, group = group), 
#                fill = 'gray90', color = 'black') + 
#   coord_fixed(ratio = 1.3, xlim = c(-100,-70), ylim = c(50, 59)) + 
#   theme_void() + 
#   geom_point(data = lc_with_geo_counts, 
#              aes(x = as.numeric(lng), 
#                  y = as.numeric(lat), size = n, color = log(n)), alpha = .7) + 
#   scale_size_area(max_size = 8) + 
#   scale_color_viridis_c() + 
#   theme(legend.position = 'none') + 
#   theme(title = element_text(size = 12))

# usa <- map_data("usa")
# states <- map_data("state")
# ny_df <- subset(states, region=="new york")
# ny_base <- ggplot(data=ny_df, mapping=aes(x=long, y=lat, group=group))+
#   coord_fixed(1.3) + 
#   geom_polygon(color="black", fill="gray")
# ny_base+theme_nothing() + geom_point(data = airbnb, aes(x=as.numeric(longitude), y=as.numeric(latitude)))
```

```{r}
top_height <- max(airbnb$latitude) - min(airbnb$latitude)
top_width <- max(airbnb$longitude) - min(airbnb$longitude)
top_borders <- c(bottom  = min(airbnb$latitude)  - 0.1 * top_height,
                 top     = max(airbnb$latitude)  + 0.1 * top_height,
                 left    = min(airbnb$longitude) - 0.1 * top_width,
                 right   = max(airbnb$longitude) + 0.1 * top_width)
ggmap(top_map) + geom_point(airbnb, mapping = aes(longitude, latitude, fill = as.factor(neighbourhood_group), size =price))+ scale_color_gradient(low = "blue", high = "red")
```   

```{r}
world <- map_data('world')
ny = world[which(world$subregion == "New York"), ]
# Okay, kinda like, civilian deaths mapped globally
world_civ <- ggplot() +
    geom_map(data = ny, map = ny, aes(long, lat, map_id = region), 
             color = 'white', fill = 'gray50', alpha = .5)
```

```{r, message = F}
min_lat = min(airbnb$latitude)
max_lat = max(airbnb$latitude)
min_long = min(airbnb$longitude)
max_long = max(airbnb$longitude)
east_coast <- subset(states, region %in% c("new york"))
p = ggplot(data = east_coast) +  geom_polygon(aes(x = long, y = lat, group  = group), fill = "white") + coord_fixed(1.3) 
p + geom_point(data = airbnb, aes(x = longitude, y=latitude, color = as.factor(neighbourhood_group))) + xlim(c(min_long, max_long)) + coord_cartesian(ylim=c(min_lat,max_lat)) + ggrepel::geom_text_repel(data = airbnb, aes(label = "MSG"), xlim = c())
```

```{r, message=F}
min_lat = min(airbnb$latitude)
max_lat = max(airbnb$latitude)
min_long = min(airbnb$longitude)
max_long = max(airbnb$longitude)
east_coast <- subset(states, region %in% c("new york"))
airbnb1 = airbnb[which(airbnb$price>500), ]
p = ggplot(data = east_coast) +  geom_polygon(aes(x = long, y = lat, group  = group), fill = "white") + coord_fixed(1.3) 
p + geom_point(data = airbnb1, aes(x = longitude, y=latitude, color = log(price), shape = as.factor(neighbourhood_group)), size = 2) + xlim(c(min_long, max_long)) + coord_cartesian(ylim=c(min_lat,max_lat)) + annotate("text", x = c(-73.9934, -73.9754, -73.9262, -73.8458), y = c(40.75, 40.68, 40.8296, 40.7571), 
           label = c("MSG", "Barclays", "Yankee Stadium", "Citi Field") , color="hot pink", 
           size=3 , angle=360, fontface="bold")
#maybe that not many expensive airbnbs around citi field-mets suck compared to the yankees
#also a lot of ppl don't stay in queens
#compare distribution of price in those areas(boxplot)
```


```{r}
min_lat = min(airbnb$latitude)
max_lat = max(airbnb$latitude)
min_long = min(airbnb$longitude)
max_long = max(airbnb$longitude)
east_coast <- subset(states, region %in% c("new york"))
airbnb1 = airbnb[which(airbnb$price>500), ]
p = ggplot(data = east_coast) +  geom_polygon(aes(x = long, y = lat, group  = group), fill = "white") + coord_fixed(1.3) 
p + geom_point(data = airbnb1, aes(x = longitude, y=latitude, color = availability_365, shape = as.factor(neighbourhood_group)), size = 2) + xlim(c(min_long, max_long)) + coord_cartesian(ylim=c(min_lat,max_lat)) + annotate("text", x = c(-73.9934, -73.9754, -73.9262, -73.8458), y = c(40.75, 40.68, 40.8296, 40.7571), 
           label = c("MSG", "Barclays", "Yankee Stadium", "Citi Field") , color="orange", 
           size=3 , angle=360, fontface="bold") + scale_fill_gradient2()
```

```{R, echo = FALSE}
min_lat = min(airbnb$latitude)
max_lat = max(airbnb$latitude)
min_long = min(airbnb$longitude)
max_long = max(airbnb$longitude)
east_coast <- subset(states, region %in% c("new york"))
airbnb1 = airbnb[which(airbnb$price>1000), ]
p = ggplot(data = east_coast) +  geom_polygon(aes(x = long, y = lat, group  = group), fill = "white") + coord_fixed(1.3) 
p + geom_point(data = airbnb1, aes(x = longitude, y=latitude, color = reviews_per_month, shape = as.factor(neighbourhood_group)), size = 2) + xlim(c(min_long, max_long)) + coord_cartesian(ylim=c(min_lat,max_lat)) + annotate("text", x = c(-73.9934, -73.9754, -73.9262), y = c(40.75, 40.68, 40.8296), 
           label = c("MSG", "Barclays", "Yankee Stadium") , color="orange", 
           size=3 , angle=360, fontface="bold")
```


