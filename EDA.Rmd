---
title: "EDA"
author: "Sarah Gaeta"
date: "4/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, message = FALSE, warning=FALSE}
setwd("~/STA160MT")
library(tidyverse)
library(readxl)
library(corrplot)
library(ggmap)
library(ggplot2)
library(dplyr)
library(tigris)
library(leaflet)
library(sp)
library(maptools)
library(broom)
library(httr)
library(rgdal)
library(sf)
library(here)
```

```{r}
airbnb =  read_csv("clean_airbnb.csv", col_types = cols(last_review = col_date(format = "%Y-%m-%d")))
```

# What causes prices to be higher and can we make a model to predict the price?
# Do the number of reviews differ per borough?
# Does price vary with neighborhood?
# cluster neighborhood


First, let's clean the data

```{r}
airbnb = airbnb %>% na.omit()
#next remove all 0's from price
price_0 = which(airbnb$price >0, )
airbnb = airbnb[price_0, ]
#use minimum nights <= 20
```



First, we will plot the correlograms between the columns of numerical type

```{r}
updated_airbnb = airbnb %>% keep(is.numeric)
updated = updated_airbnb[,-c(1,2,3,4)] %>% na.omit()
#pairs(updated)
```

Next, we will plot the respective correlation matrix between the numerical variables:

```{r}
corrplot(cor(updated), method = "number")
```

```{r}
summary(updated)
```

We will get rid of zero price, because a price of 0 is senseless:

```{r}
price_over0 = which(airbnb$price > 0)
airbnb = airbnb[price_over0, ]
```

Then, get the count of each borough:

```{r}
ggplot(airbnb, aes(x=neighbourhood_group, fill = as.factor(neighbourhood_group))) + geom_bar()
```

Look at the mean price for each borough:


First, we want to see if prices are greater for certain neighborhood groups:
#cheaper airbnbs

```{r}
ggplot(airbnb[which(airbnb$price <= 175), ], aes(x= neighbourhood_group , y= price)) + geom_boxplot()
```
average listenings in Manhattan more expensive ish than average of other groups.


#more expensive:
```{r}
ggplot(airbnb[which(airbnb$price > 1000), ], aes(x= neighbourhood_group , y= price)) + geom_boxplot()
```

more variability around the more expensive groups in Broklyn and Queens

# what kind of airbnb has prices over 1000?-could be interesting(what is similar-could be specific people)
```{r}
price_500 = which(airbnb$price >= 500)
airbnb_over_500 = airbnb[price_500, ]
ggplot(airbnb_over_500, aes(neighbourhood_group, fill = neighbourhood_group)) + geom_bar()
```



```{r}
price_1000 = which(airbnb$price >= 500)
airbnb_over_1000 = airbnb[price_1000, ]
manhattan_1000 = which(airbnb_over_1000$neighbourhood_group == "Manhattan")
airbnb_man_1000 = airbnb_over_1000[manhattan_1000, ]
ggplot(airbnb_man_1000, aes(price, fill = room_type)) + geom_histogram()
```

From the plot above, we can see that for prices over $1000, we see that across all the prices, the ones that cost the most are entire homes/apts.

Let's find out which borough has more of which room type for the more expensive prices(over 1000).

```{r}
expensive_air = airbnb_over_1000 %>% group_by(neighbourhood_group) %>% count(room_type)
ggplot(data = expensive_air, aes(x=room_type, y=n, fill = as.factor(neighbourhood_group))) + geom_bar(stat = "identity", position =position_dodge())
```

This pattern of more expensive apartments(1000+) being entire homes holds true.

Let's take a look at 




We will remove the name and host_name columns since they are represented by id and host_id:

```{r}
new_air = airbnb[, -c(2, 4)]
```   








```{r}
ny = ggplot(data = airbnb, aes(longitude, latitude, color = as.factor(neighbourhood_group))) + coord_quickmap() + geom_point() + annotate("text", x= -74, y = 40.75 , label = "MSG") 
ny
msg = c(-40.75, -73.9934)
usa <- map_data("usa")
states <- map_data("state")
```


```{r}
# ggplot() + 
#   geom_polygon(data = worldmap, 
#                aes(x = long, y = lat, group = group), 
#                fill = 'gray90', color = 'black') + 
#   coord_fixed(ratio = 1.3, xlim = c(-100,-70), ylim = c(50, 59)) + 
#   theme_void() + 
#   geom_point(data = lc_with_geo_counts, 
#              aes(x = as.numeric(lng), 
#                  y = as.numeric(lat), size = n, color = log(n)), alpha = .7) + 
#   scale_size_area(max_size = 8) + 
#   scale_color_viridis_c() + 
#   theme(legend.position = 'none') + 
#   theme(title = element_text(size = 12))
# usa <- map_data("usa")
# states <- map_data("state")
# ny_df <- subset(states, region=="new york")
# ny_base <- ggplot(data=ny_df, mapping=aes(x=long, y=lat, group=group))+
#   coord_fixed(1.3) + 
#   geom_polygon(color="black", fill="gray")
# ny_base+theme_nothing() + geom_point(data = airbnb, aes(x=as.numeric(longitude), y=as.numeric(latitude)))
```

```{r}
world <- map_data('world')
ny = world[which(world$subregion == "New York"), ]
# Okay, kinda like, civilian deaths mapped globally
world_civ <- ggplot() +
    geom_map(data = ny, map = ny, aes(long, lat, map_id = region), 
             color = 'white', fill = 'gray50', alpha = .5)
```

```{r, message = F}
min_lat = min(airbnb$latitude)
max_lat = max(airbnb$latitude)
min_long = min(airbnb$longitude)
max_long = max(airbnb$longitude)
east_coast <- subset(states, region %in% c("new york"))
p = ggplot(data = east_coast) +  geom_polygon(aes(x = long, y = lat, group  = group), fill = "white") + coord_fixed(1.3) 
p + geom_point(data = airbnb, aes(x = longitude, y=latitude, color = as.factor(neighbourhood_group))) + xlim(c(min_long, max_long)) + coord_cartesian(ylim=c(min_lat,max_lat))
```

```{r, message=F}
min_lat = min(airbnb$latitude)
max_lat = max(airbnb$latitude)
min_long = min(airbnb$longitude)
max_long = max(airbnb$longitude)
east_coast <- subset(states, region %in% c("new york"))
airbnb1 = airbnb[which(airbnb$price>500), ]
p = ggplot(data = east_coast) +  geom_polygon(aes(x = long, y = lat, group  = group), fill = "white") + coord_fixed(1.3) 
p + geom_point(data = airbnb1, aes(x = longitude, y=latitude, color = log(price), shape = as.factor(neighbourhood_group)), size = 2) + xlim(c(min_long, max_long)) + coord_cartesian(ylim=c(min_lat,max_lat)) + annotate("text", x = c(-73.9934, -73.9754, -73.9262, -73.8458), y = c(40.75, 40.68, 40.8296, 40.7571), 
           label = c("MSG", "Barclays", "Yankee Stadium", "Citi Field") , color="hot pink", 
           size=3 , angle=360, fontface="bold")
#maybe that not many expensive airbnbs around citi field-mets suck compared to the yankees
#also a lot of ppl don't stay in queens
#compare distribution of price in those areas(boxplot)
```


```{r}
min_lat = min(airbnb$latitude)
max_lat = max(airbnb$latitude)
min_long = min(airbnb$longitude)
max_long = max(airbnb$longitude)
east_coast <- subset(states, region %in% c("new york"))
airbnb1 = airbnb[which(airbnb$price>500), ]
p = ggplot(data = east_coast) +  geom_polygon(aes(x = long, y = lat, group  = group), fill = "white") + coord_fixed(1.3) 
p + geom_point(data = airbnb1, aes(x = longitude, y=latitude, color = availability_365, shape = as.factor(neighbourhood_group)), size = 2) + xlim(c(min_long, max_long)) + coord_cartesian(ylim=c(min_lat,max_lat)) + annotate("text", x = c(-73.9934, -73.9754, -73.9262, -73.8458), y = c(40.75, 40.68, 40.8296, 40.7571), 
           label = c("MSG", "Barclays", "Yankee Stadium", "Citi Field") , color="orange", 
           size=3 , angle=360, fontface="bold") + scale_fill_gradient2()
```

```{R, echo = FALSE}
min_lat = min(airbnb$latitude)
max_lat = max(airbnb$latitude)
min_long = min(airbnb$longitude)
max_long = max(airbnb$longitude)
east_coast <- subset(states, region %in% c("new york"))
airbnb1 = airbnb[which(airbnb$price>1000), ]
p = ggplot(data = east_coast) +  geom_polygon(aes(x = long, y = lat, group  = group), fill = "white") + coord_fixed(1.3) 
p + geom_point(data = airbnb1, aes(x = longitude, y=latitude, color = reviews_per_month, shape = as.factor(neighbourhood_group)), size = 2) + xlim(c(min_long, max_long)) + coord_cartesian(ylim=c(min_lat,max_lat)) + annotate("text", x = c(-73.9934, -73.9754, -73.9262), y = c(40.75, 40.68, 40.8296), 
           label = c("MSG", "Barclays", "Yankee Stadium") , color="orange", 
           size=3 , angle=360, fontface="bold")
```

```{r}
# convert price into 2 categorical groups
price_categorical = 1:length(airbnb$price)
for (i in price_categorical) {
  if (airbnb$price[i] > 175){
   price_categorical[i] = "expensive"
  }
  else {
    price_categorical[i] = "not expensive"
  }
}
airbnb_price_categorical = cbind(airbnb, price_categorical)
```

# Boxplot of neighbor group vs room types for prices over 1000

```{r}
# subset to only include airbnbs with prices over 1000
price_1000 = which(airbnb$price >= 1000)
airbnb_over_1000 = airbnb[price_1000, ]
# plot room vs price for each neightborhood group
ggplot(airbnb_over_1000, aes(x = room_type, y=price, color = neighbourhood_group))+ geom_boxplot() + ggtitle("Price Per Room Type for Each Neighbourhood Group")
```


```{r}
#subset airbnb for only manhattan data
manhattan = which(airbnb_price_categorical$neighbourhood_group == "Manhattan")
airbnb_manhattan = airbnb_price_categorical[manhattan, ]
#subset data for only expensive airbnbs in manhattan
manhattan_expensive = which(airbnb_manhattan$price_categorical == "expensive")
airbnb_manhattan_expensive = airbnb_manhattan[manhattan_expensive, ]
#find number of expensive and inexpensive airbnbs
num_exp_manhattan = length(airbnb_manhattan_expensive$price)
num_inexp_manhattan = length(airbnb_manhattan$price) - num_exp_manhattan
#subset airbnb for only brooklyn data
brooklyn = which(airbnb_price_categorical$neighbourhood_group == "Brooklyn")
airbnb_brooklyn = airbnb_price_categorical[brooklyn, ]
#subset data for only expensive airbnbs in brooklyn
brooklyn_expensive = which(airbnb_brooklyn$price_categorical == "expensive")
airbnb_brooklyn_expensive = airbnb_brooklyn[brooklyn_expensive, ]
#find number of expensive and inexpensive airbnbs
num_exp_brooklyn = length(airbnb_brooklyn_expensive$price)
num_inexp_brooklyn = length(airbnb_brooklyn$price) - num_exp_brooklyn
#subset airbnb for only queens data
queens = which(airbnb_price_categorical$neighbourhood_group == "Queens")
airbnb_queens = airbnb_price_categorical[queens, ]
#subset data for only expensive airbnbs in queens
queens_expensive = which(airbnb_queens$price_categorical == "expensive")
airbnb_queens_expensive = airbnb_queens[queens_expensive, ]
#find number of expensive and inexpensive airbnbs
num_exp_queens = length(airbnb_queens_expensive$price)
num_inexp_queens = length(airbnb_queens$price) - num_exp_queens
#subset airbnb for only bronx data
bronx = which(airbnb_price_categorical$neighbourhood_group == "Bronx")
airbnb_bronx = airbnb_price_categorical[bronx, ]
bronx_expensive = which(airbnb_bronx$price_categorical == "expensive")
#subset data for only expensive airbnbs in bronx
airbnb_bronx_expensive = airbnb_bronx[bronx_expensive, ]
#find number of expensive and inexpensive airbnbs
num_exp_bronx = length(airbnb_bronx_expensive$price)
num_inexp_bronx = length(airbnb_bronx$price) - num_exp_bronx
#subset airbnb for only staten data
staten_island = which(airbnb_price_categorical$neighbourhood_group == "Staten Island")
airbnb_staten_island = airbnb_price_categorical[staten_island, ]
#subset data for only expensive airbnbs in staten island
staten_island_expensive = which(airbnb_staten_island$price_categorical == "expensive")
airbnb_staten_island_expensive = airbnb_staten_island[staten_island_expensive, ]
#find number of expensive and inexpensive airbnbs
num_exp_staten_island = length(airbnb_staten_island_expensive$price)
num_inexp_staten_island = length(airbnb_staten_island$price) - num_exp_staten_island
```

```{r}
# categories of pie chart
data <- data.frame(slices = c(num_exp_manhattan, num_inexp_manhattan),
                   price_type = c("Expensive","Not Expensive"),
                   stringsAsFactors = F)
# find percentages of categories
data <- data %>% 
  mutate(per=slices/sum(slices)) %>% 
  arrange(desc(price_type))
data$label <- scales::percent(data$per)
# Plot pie graph
ggplot(data=data)+
  geom_bar(aes(x="", y=per, fill=price_type), stat="identity", width = 1)+
  coord_polar("y", start=0)+
  theme_void()+
  geom_text(aes(x=1, y = cumsum(per) - per/2, label=label))+
  ggtitle("Percentage of Expensive vs. Not Expensive Airbnbs for Manhattan")
```

```{r}
# categories of pie chart
data <- data.frame(slices = c(num_exp_brooklyn, num_inexp_brooklyn),
                   price_type = c("Expensive","Not Expensive"),
                   stringsAsFactors = F)
# find percentages of categories
data <- data %>% 
  mutate(per=slices/sum(slices)) %>% 
  arrange(desc(price_type))
data$label <- scales::percent(data$per)
# Plot pie graph
ggplot(data=data)+
  geom_bar(aes(x="", y=per, fill=price_type), stat="identity", width = 1)+
  coord_polar("y", start=0)+
  theme_void()+
  geom_text(aes(x=1, y = cumsum(per) - per/2, label=label))+
  ggtitle("Percentage of Expensive vs. Not Expensive Airbnbs for Brooklyn")
```

```{r}
# categories of pie chart
data <- data.frame(slices = c(num_exp_queens, num_inexp_queens),
                   price_type = c("Expensive","Not Expensive"),
                   stringsAsFactors = F)
# find percentages of categories
data <- data %>% 
  mutate(per=slices/sum(slices)) %>% 
  arrange(desc(price_type))
data$label <- scales::percent(data$per)
# Plot pie graph
ggplot(data=data)+
  geom_bar(aes(x="", y=per, fill=price_type), stat="identity", width = 1)+
  coord_polar("y", start=0)+
  theme_void()+
  geom_text(aes(x=1, y = cumsum(per) - per/2, label=label))+
  ggtitle("Percentage of Expensive vs. Not Expensive Airbnbs for Queens")
```

```{r}
# categories of pie chart
data <- data.frame(slices = c(num_exp_bronx, num_inexp_bronx),
                   price_type = c("Expensive","Not Expensive"),
                   stringsAsFactors = F)
# find percentages
data <- data %>% 
  mutate(per=slices/sum(slices)) %>% 
  arrange(desc(price_type))
data$label <- scales::percent(data$per)
# Plot pie graph
ggplot(data=data)+
  geom_bar(aes(x="", y=per, fill=price_type), stat="identity", width = 1)+
  coord_polar("y", start=0)+
  theme_void()+
  geom_text(aes(x=1, y = cumsum(per) - per/2, label=label))+
  ggtitle("Percentage of Expensive vs. Not Expensive Airbnbs for Bronx")
```

```{r}
# categories of pie chart
data <- data.frame(slices = c(num_exp_staten_island, num_inexp_staten_island),
                   price_type = c("Expensive","Not Expensive"),
                   stringsAsFactors = F)
# find percentages
data <- data %>% 
  mutate(per=slices/sum(slices)) %>% 
  arrange(desc(price_type))
data$label <- scales::percent(data$per)
# Plot pie graph
ggplot(data=data)+
  geom_bar(aes(x="", y=per, fill=price_type), stat="identity", width = 1)+
  coord_polar("y", start=0)+
  theme_void()+
  geom_text(aes(x=1, y = cumsum(per) - per/2, label=label))+
  ggtitle("Percentage of Expensive vs. Not Expensive Airbnbs for Staten Island")
```


# Top 10 Most Expensive Airbnbs

```{r, message = F}
# arrange neighbourhood prices in decreasing order 
med_price_neighborhoods <- airbnb %>%
  group_by(neighbourhood, neighbourhood_group) %>%
  summarize(median_price = median(price, na.rm = TRUE)) %>%
  arrange(desc(median_price))
# 10 most expensive airbnbs
most_exp = med_price_neighborhoods[1:10,]
p<-ggplot(most_exp, aes(x=neighbourhood, y=median_price, fill= neighbourhood_group)) +
  geom_bar(stat="identity")+theme_minimal() + ggtitle("10 Most Expensive Neighbourhoods by Median")
p
```

